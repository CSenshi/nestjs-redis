services:
  redis:
    image: redis:8-alpine
    ports:
      - '6379:6379'

  redis-cluster:
    image: redis/redis-stack:latest
    command: |
      sh -c '
        redis-server --port 6380 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --loadmodule /opt/redis-stack/lib/redisearch.so --loadmodule /opt/redis-stack/lib/rejson.so --protected-mode no --bind 0.0.0.0 &
        sleep 5
        redis-cli -p 6380 cluster meet 127.0.0.1 6380 || true
        redis-cli -p 6380 cluster addslots $(seq 0 16383 | tr "\n" " ") || true
        wait
      '
    ports:
      - '6380:6380'
